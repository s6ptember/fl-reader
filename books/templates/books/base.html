{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>{% block title %}Lumina Reader - –û–Ω–ª–∞–π–Ω –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –∫–Ω–∏–≥{% endblock %}</title>

    <meta name="description" content="{% block description %}Lumina Reader - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤–µ–±-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –∫–Ω–∏–≥ –æ–Ω–ª–∞–π–Ω. –°–∫–∞—á–∏–≤–∞–π—Ç–µ –∫–Ω–∏–≥–∏ —Å –§–ª–∏–±—É—Å—Ç—ã, —á–∏—Ç–∞–π—Ç–µ –≤ —É–¥–æ–±–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.{% endblock %}">
    <meta name="keywords" content="{% block keywords %}—á–∏—Ç–∞—Ç—å –∫–Ω–∏–≥–∏ –æ–Ω–ª–∞–π–Ω, –≤–µ–±-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞, —Ñ–ª–∏–±—É—Å—Ç–∞, fb2, —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏, –æ–Ω–ª–∞–π–Ω —Ä–∏–¥–µ—Ä, lumina reader{% endblock %}">
    <meta name="author" content="Lumina Reader">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="{% block canonical %}{{ request.build_absolute_uri }}{% endblock %}">

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'icons/favicon-32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'icons/favicon-16.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'icons/apple-touch-icon.png' %}">

    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static 'manifest.json' %}">

    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lumina">

    <!-- Android PWA Support -->
    <meta name="mobile-web-app-capable" content="yes">

    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:title" content="{% block og_title %}Lumina Reader - –û–Ω–ª–∞–π–Ω –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –∫–Ω–∏–≥{% endblock %}">
    <meta property="og:description" content="{% block og_description %}–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤–µ–±-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –∫–Ω–∏–≥ –æ–Ω–ª–∞–π–Ω —Å —É–¥–æ–±–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞{% endblock %}">
    <meta property="og:url" content="{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}">
    <meta property="og:site_name" content="Lumina Reader">
    <meta property="og:locale" content="ru_RU">
    {% block og_image %}
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'favicon.svg' %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    {% endblock %}

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}Lumina Reader - –û–Ω–ª–∞–π–Ω –±–∏–±–ª–∏–æ—Ç–µ–∫–∞{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}–ß–∏—Ç–∞–π—Ç–µ –∫–Ω–∏–≥–∏ –æ–Ω–ª–∞–π–Ω —Å —É–¥–æ–±–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞{% endblock %}">
    {% block twitter_image %}
    <meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'favicon.svg' %}">
    {% endblock %}

    <meta name="theme-color" content="#000000">
    <meta name="color-scheme" content="dark">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="{% static 'css/output.css' %}" rel="stylesheet">
    <script src="{% static 'js/htmx.min.js' %}"></script>

    {% block structured_data %}
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Lumina Reader",
        "description": "–û–Ω–ª–∞–π–Ω –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –∫–Ω–∏–≥",
        "url": "{{ request.scheme }}://{{ request.get_host }}",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "{{ request.scheme }}://{{ request.get_host }}/search/?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    {% endblock %}

    {% block extra_css %}{% endblock %}
</head>
<body class="bg-black text-white overflow-x-hidden selection:bg-blue-500/30">

    <div id="messages"></div>

    <div id="root" class="relative min-h-screen w-full">
        <div class="fixed inset-0 z-0 bg-black pointer-events-none"></div>

        <main id="main-content" class="relative z-10 w-full min-h-screen" hx-history-elt>
            {% block content %}{% endblock %}
        </main>
    </div>

    <script>
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });
    </script>

    <script defer>
        document.addEventListener('alpine:init', () => {
            Alpine.store('flibusta', {
                modalOpen: false
            });

            Alpine.store('reader', {
                fontSize: 18,
                scrollProgress: 0,
                isControlsVisible: true
            });

            console.log('Alpine.js initialized with stores:', Alpine.store('flibusta'));
        });
    </script>

    <script defer src="{% static 'js/alpine.min.js' %}"></script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('{% static "sw.js" %}')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration.scope);

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
                        setInterval(() => {
                            registration.update();
                        }, 60000);

                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Service Worker
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞
                                    if (confirm('–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç—å?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', error);
                    });

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–≥–¥–∞ –Ω–æ–≤—ã–π SW –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        refreshing = true;
                        window.location.reload();
                    }
                });
            });

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–∏–≥–∏ –¥–ª—è offline —á—Ç–µ–Ω–∏—è
            window.cacheBookForOffline = function(bookUrl) {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'CACHE_BOOK',
                        url: bookUrl
                    });
                }
            };
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ UI)
            console.log('üí° PWA –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            window.showInstallPrompt = () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–∏–ª PWA');
                        }
                        deferredPrompt = null;
                    });
                }
            };
        });

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —É—Å–ø–µ—à–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É PWA
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            deferredPrompt = null;
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
